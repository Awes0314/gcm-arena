# 要件定義書

## はじめに

GCM Arenaは、SEGAの音楽ゲーム（オンゲキ、CHUNITHM、maimai）を対象とした非公式のカスタム大会プラットフォームです。ユーザーは自由なルールで大会を作成し、スコアを提出して参加し、ランキングを閲覧できます。本サービスはSEGAとは一切関係のない非公式サービスです。

## 用語集

- **システム**: GCM Arenaプラットフォーム
- **ユーザー**: 大会に参加または開催できる登録済みの人
- **大会**: 定義されたルール、対象楽曲、期間を持つ競技会
- **開催者**: 大会を作成・管理するユーザー
- **参加者**: 大会に参加するユーザー
- **スコア提出**: 特定の楽曲におけるユーザーのプレイ記録
- **ブックマークレット**: 公式ゲームサイトからスコアデータを抽出するブラウザスクリプト
- **画像提出**: 手動検証用のゲーム結果スクリーンショットのアップロード
- **ランキング**: スコアに基づいて順序付けられた参加者のリスト
- **プロフィール**: 表示名とメタデータを含むユーザーアカウント情報
- **RLS**: データベースの行レベルセキュリティポリシー

## 要件

### 要件1: ユーザー認証とプロフィール管理

**ユーザーストーリー:** ユーザーとして、登録してプロフィールを管理したい。そうすることで、大会に参加して活動を追跡できる。

#### 受入基準

1. WHEN ユーザーがメールアドレスとパスワードで登録する、THE システム SHALL Supabase Authを使用してアカウントを作成する
2. WHEN ユーザーが正常にログインする、THE システム SHALL 認証済み機能へのアクセスを許可する
3. WHEN ユーザーが表示名を更新する、THE システム SHALL プロフィールへの変更を永続化する
4. THE システム SHALL id、display_name、created_at、updated_at、is_active、deleted_atフィールドを持つprofilesテーブルにユーザープロフィールを保存する
5. WHEN ユーザーがauth.usersから削除される、THE システム SHALL プロフィールレコードをカスケード削除する
6. THE システム SHALL すべてのユーザーが任意のプロフィールを閲覧できるようにする
7. THE システム SHALL RLSポリシーを通じてユーザーが自分自身のプロフィールのみを更新できるようにする

### 要件2: 大会の作成と管理

**ユーザーストーリー:** 開催者として、カスタムルールで大会を作成したい。そうすることで、特定の楽曲と期間で競技会を開催できる。

#### 受入基準

1. WHEN ユーザーが大会を作成する、THE システム SHALL 対象ゲーム、対象楽曲、開始時刻、終了時刻、提出方式、詳細ルールを保存する
2. THE システム SHALL 各ユーザーが同時に開催できるアクティブな大会を1つまでに制限する
3. WHEN 大会が作成される、THE システム SHALL 作成したユーザーを開催者として割り当てる
4. THE システム SHALL 各大会に少なくとも1つの対象楽曲を必要とする
5. WHEN 開催者が大会の詳細を更新する、THE システム SHALL 大会が開始していない場合に変更を永続化する
6. THE システム SHALL オンゲキ、CHUNITHM、maimaiゲームの大会をサポートする
7. THE システム SHALL 開催者がブックマークレットと画像提出の両方の方式を指定できるようにする

### 要件3: 大会への参加

**ユーザーストーリー:** ユーザーとして、大会に参加・離脱したい。そうすることで、興味のある競技会に参加できる。

#### 受入基準

1. WHEN ログイン済みユーザーが大会に参加する、THE システム SHALL 参加記録を作成する
2. WHEN ユーザーが大会から離脱する、THE システム SHALL 参加記録を削除する
3. THE システム SHALL ユーザーごとの大会参加数を無制限にする
4. THE システム SHALL 開催者が自分の大会に参加できるようにする
5. THE システム SHALL 非認証ユーザーが大会に参加することを防止する
6. WHEN ユーザーが既に参加済みの大会に参加しようとする、THE システム SHALL 重複参加を防止する

### 要件4: ブックマークレットによるスコア提出

**ユーザーストーリー:** 参加者として、ブックマークレットを使用してスコアを提出したい。そうすることで、公式ゲームサイトから素早くプレイ記録を登録できる。

#### 受入基準

1. WHEN ユーザーが公式ゲームページでブックマークレットを実行する、THE システム SHALL DOMからスコア情報を抽出する
2. WHEN スコアデータが抽出される、THE システム SHALL 即座に処理するためにAPIに送信する
3. WHEN APIがブックマークレットデータを受信する、THE システム SHALL スコア提出を検証して保存する
4. THE システム SHALL 各スコア提出を提出ユーザーと対象大会に関連付ける
5. IF 公式サイトの構造が変更される、THE システム SHALL 不正確なデータを防ぐために即座にシャットダウンできる
6. WHEN スコアが提出される、THE システム SHALL その楽曲に対する参加者の記録を更新する

### 要件5: 画像アップロードによるスコア提出

**ユーザーストーリー:** 参加者として、リザルトのスクリーンショットを提出したい。そうすることで、ブックマークレットが利用できない場合に証明を提供できる。

#### 受入基準

1. WHEN ユーザーがリザルト画像をアップロードする、THE システム SHALL Supabase Storageに保存する
2. WHEN 画像がアップロードされる、THE システム SHALL 保留中の提出記録を作成する
3. WHEN 開催者が画像提出をレビューする、THE システム SHALL 手動でのスコア入力を許可する
4. WHEN 大会が終了する、THE システム SHALL 関連するすべての画像を自動的に削除する
5. THE システム SHALL 各画像提出を提出ユーザーと大会に関連付ける
6. THE システム SHALL リザルトスクリーンショット用の一般的な画像形式をサポートする

### 要件6: ランキングの計算と表示

**ユーザーストーリー:** 参加者として、大会のランキングを閲覧したい。そうすることで、自分の順位を確認し、他の参加者と比較できる。

#### 受入基準

1. WHEN スコアが提出される、THE システム SHALL 大会ルールに基づいてランキングを再計算する
2. THE システム SHALL ランキングをスコアの降順で表示する
3. THE システム SHALL 開催者による手動のランキング再計算をサポートする
4. WHEN 大会が公開である、THE システム SHALL 非参加者がランキングを閲覧できるようにする
5. WHEN 大会が非公開である、THE システム SHALL ランキングの閲覧を参加者のみに制限する
6. THE システム SHALL ランキングビューに参加者名、スコア、順位を表示する

### 要件7: 大会の検索と閲覧

**ユーザーストーリー:** ユーザーとして、大会を閲覧して詳細を確認したい。そうすることで、参加する競技会を見つけられる。

#### 受入基準

1. WHEN ユーザーが大会一覧ページを訪問する、THE システム SHALL すべての公開大会を表示する
2. WHEN ユーザーが大会詳細を閲覧する、THE システム SHALL ゲーム、楽曲、期間、ルール、現在の参加者を表示する
3. THE システム SHALL ゲームタイプによる大会のフィルタリングを許可する
4. THE システム SHALL 大会のステータス（開催前、開催中、終了）を表示する
5. WHEN 大会が非公開である、THE システム SHALL 公開リストから非表示にする
6. THE システム SHALL 各大会の開催者名を表示する

### 要件8: 開催者管理インターフェース

**ユーザーストーリー:** 開催者として、大会を管理したい。そうすることで、提出を確認し、設定を更新できる。

#### 受入基準

1. WHEN 開催者が管理ページにアクセスする、THE システム SHALL 大会のすべての提出を表示する
2. WHEN 開催者が画像提出を閲覧する、THE システム SHALL 手動でのスコア入力を許可する
3. THE システム SHALL 開催者がランキングの再計算をトリガーできるようにする
4. THE システム SHALL 開催者に参加者の統計を表示する
5. THE システム SHALL 開催者が開始日前に大会の詳細を更新できるようにする
6. THE システム SHALL 大会開始後に開催者がコアルールを変更することを防止する

### 要件9: アプリ内通知

**ユーザーストーリー:** ユーザーとして、大会イベントに関する通知を受け取りたい。そうすることで、重要な更新について情報を得られる。

#### 受入基準

1. WHEN 大会関連のイベントが発生する、THE システム SHALL データベースに通知レコードを作成する
2. WHEN ユーザーが通知を閲覧する、THE システム SHALL 未読通知を目立つように表示する
3. THE システム SHALL ユーザーが通知を既読としてマークできるようにする
4. THE システム SHALL 大会の開始、終了、新規参加者の通知をサポートする
5. THE システム SHALL user_id、message、created_at、is_readフィールドを持つ通知を保存する
6. THE システム SHALL ユーザーが通知履歴を閲覧できるようにする

### 要件10: 楽曲と譜面データの管理

**ユーザーストーリー:** システム管理者として、最新の楽曲と譜面情報を維持したい。そうすることで、大会が正確なゲームデータを参照できる。

#### 受入基準

1. THE システム SHALL サポートされているゲームのすべての楽曲と譜面レベルを保存する
2. THE システム SHALL 楽曲データの週次バッチ更新をサポートする
3. WHEN 楽曲データが更新される、THE システム SHALL 既存の大会参照を保持する
4. THE システム SHALL ゲームタイプ、タイトル、難易度、レベル情報を持つ楽曲データを保存する
5. THE システム SHALL 利用可能な楽曲を取得するためのAPIエンドポイントを提供する
6. THE システム SHALL JSONベースの楽曲データインポートをサポートする

### 要件11: マルチ環境データベーススキーマ管理

**ユーザーストーリー:** 開発者として、スキーマベースの環境分離を使用したい。そうすることで、本番データに影響を与えずに安全に開発できる。

#### 受入基準

1. THE システム SHALL 複数のスキーマを持つ単一のSupabaseプロジェクトを使用する
2. THE システム SHALL 開発環境に「dev」スキーマを使用する
3. THE システム SHALL 本番環境に「public」スキーマを使用する
4. WHEN SUPABASE_SCHEMA環境変数が設定される、THE システム SHALL 指定されたスキーマに接続する
5. THE システム SHALL devとpublicスキーマ間で同一のテーブル構造を維持する
6. THE システム SHALL すべての環境でSupabase認証にauthスキーマを使用する

### 要件12: 利用規約と免責事項

**ユーザーストーリー:** サービス提供者として、規約と免責事項を表示したい。そうすることで、ユーザーがこれが非公式サービスであることを理解できる。

#### 受入基準

1. THE システム SHALL ユーザー登録前に利用規約ページを表示する
2. THE システム SHALL アカウント作成前にユーザーが規約に同意することを要求する
3. THE システム SHALL サービスが非公式でありSEGAとは無関係であることを明確に記載する
4. THE システム SHALL ゲームデータとサービス可用性に関する責任免責を含める
5. THE システム SHALL フッターリンクからすべてのページで規約にアクセスできるようにする
6. WHEN 規約が更新される、THE システム SHALL 既存ユーザーに通知する

### 要件13: アクセス制御とセキュリティ

**ユーザーストーリー:** システムアーキテクトとして、適切なアクセス制御を実施したい。そうすることで、ユーザーが自分のデータと承認されたリソースのみを変更できる。

#### 受入基準

1. THE システム SHALL すべてのユーザー向けテーブルに行レベルセキュリティポリシーを実装する
2. WHEN ユーザーが他のユーザーのデータを変更しようとする、THE システム SHALL リクエストを拒否する
3. THE システム SHALL 認証なしで公開大会データの読み取りを許可する
4. THE システム SHALL すべての書き込み操作に認証を要求する
5. THE システム SHALL 直接API アクセスが権限チェックをバイパスすることを防止する
6. THE システム SHALL クライアントとサーバーの両側でユーザー権限を検証する

### 要件14: デプロイと環境管理

**ユーザーストーリー:** 開発者として、自動デプロイパイプラインが欲しい。そうすることで、コード変更が安全に本番環境にデプロイされる。

#### 受入基準

1. WHEN コードがmainブランチにプッシュされる、THE システム SHALL Vercelで本番環境にデプロイする
2. WHEN コードがfeatureブランチにプッシュされる、THE システム SHALL プレビューデプロイメントを作成する
3. THE システム SHALL Supabase接続を設定するために環境変数を使用する
4. THE システム SHALL 開発環境と本番環境の環境変数を分離する
5. THE システム SHALL コードの信頼できる情報源としてGitHubを維持する
6. THE システム SHALL 以前のデプロイメントへのロールバックをサポートする
