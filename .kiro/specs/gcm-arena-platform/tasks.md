# 実装計画: GCM Arena プラットフォーム

## 概要

本実装計画は、Next.js App RouterとSupabaseを使用した音楽ゲーム大会プラットフォームの段階的な構築を定義します。各タスクは前のタスクの上に構築され、コア機能を早期に検証します。

## タスク

- [x] 1. プロジェクトのセットアップと基盤構築
  - Next.js プロジェクトを作成（App Router、TypeScript、Tailwind CSS）
  - Supabase クライアントライブラリをインストール
  - 環境変数の設定（.env.local）
  - src/ ディレクトリ構造を作成
  - _要件: 14.3_

- [x] 2. Supabase データベーススキーマの作成
  - [x] 2.1 dev スキーマに基本テーブルを作成
    - profiles テーブル
    - tournaments テーブル（enum型を含む）
    - tournament_songs テーブル
    - participants テーブル
    - scores テーブル
    - songs テーブル
    - notifications テーブル
    - _要件: 1.4, 2.1, 3.1, 4.4, 5.1, 9.5, 10.4_

  - [x] 2.2 RLS ポリシーを実装
    - profiles テーブルのポリシー（閲覧、更新）
    - tournaments テーブルのポリシー（公開/非公開）
    - participants テーブルのポリシー
    - scores テーブルのポリシー
    - notifications テーブルのポリシー
    - _要件: 1.6, 1.7, 2.5, 3.1, 3.2, 4.3, 5.3, 9.2, 13.1, 13.2_

  - [x] 2.3 RLS ポリシーのプロパティテストを作成
    - **プロパティ 1: プロフィール更新の所有権**
    - **プロパティ 2: プロフィールの閲覧可能性**
    - **プロパティ 34: 他人のデータ変更の防止**
    - **プロパティ 35: 公開データの非認証閲覧**
    - **プロパティ 36: 書き込み操作の認証要件**
    - **プロパティ 37: RLSによる権限チェック**
    - **検証: 要件 1.6, 1.7, 13.2, 13.3, 13.4, 13.5, 13.6**

  - [x] 2.4 データベース関数とビューを作成
    - calculate_ranking 関数
    - tournaments_with_status ビュー
    - _要件: 6.1, 7.4_

  - [x] 2.5 データベース関数のユニットテストを作成
    - ランキング計算の正確性テスト
    - ステータス計算のテスト
    - _要件: 6.1, 7.4_

- [x] 3. 認証システムの実装
  - [x] 3.1 Supabase クライアントヘルパーを作成
    - lib/supabase/client.ts（クライアント用）
    - lib/supabase/server.ts（サーバー用）
    - lib/supabase/middleware.ts（Middleware用）
    - _要件: 1.1, 1.2_

  - [x] 3.2 Next.js Middleware でセッション管理を実装
    - middleware.ts を作成
    - セッションリフレッシュロジック
    - 保護されたルートの定義
    - _要件: 1.2_

  - [x] 3.3 認証UIコンポーネントを作成
    - LoginForm コンポーネント
    - RegisterForm コンポーネント
    - ログイン/登録ページ
    - _要件: 1.1, 1.2_

  - [x] 3.4 認証フローのユニットテストを作成
    - ログイン成功/失敗のテスト
    - 登録成功/失敗のテスト
    - セッション管理のテスト
    - _要件: 1.1, 1.2_

- [x] 4. チェックポイント - 認証とデータベースの動作確認
  - すべてのテストが通過することを確認
  - ユーザー登録とログインが機能することを確認
  - 質問があればユーザーに確認

- [x] 5. プロフィール管理機能の実装
  - [x] 5.1 プロフィール表示・編集コンポーネントを作成
    - ProfileView コンポーネント
    - ProfileEditForm コンポーネント
    - マイページ（/my/page.tsx）
    - プロフィール編集ページ（/my/profile/page.tsx）
    - _要件: 1.3_

  - [x] 5.2 プロフィール更新APIを実装
    - API Route: /api/profile/route.ts
    - バリデーション
    - エラーハンドリング
    - _要件: 1.3_

  - [x] 5.3 プロフィール機能のプロパティテストを作成
    - **プロパティ 1: プロフィール更新の所有権**
    - **プロパティ 2: プロフィールの閲覧可能性**
    - **検証: 要件 1.3, 1.6, 1.7**

- [x] 6. 楽曲データ管理の実装
  - [x] 6.1 楽曲データインポート機能を作成
    - JSONパーサー
    - バッチインポートスクリプト
    - _要件: 10.1, 10.2, 10.6_

  - [x] 6.2 楽曲取得APIを実装
    - API Route: /api/songs/route.ts
    - ゲームタイプによるフィルタリング
    - _要件: 10.5_

  - [x] 6.3 楽曲データのプロパティテストを作成
    - **プロパティ 31: 楽曲データの参照整合性**
    - **プロパティ 32: JSONインポートのラウンドトリップ**
    - **検証: 要件 10.3, 10.6**

- [x] 7. 大会作成機能の実装
  - [x] 7.1 大会作成フォームコンポーネントを作成
    - TournamentForm コンポーネント
    - 楽曲選択UI
    - 期間設定（DatePicker）
    - ルール入力フィールド
    - 大会作成ページ（/tournaments/create/page.tsx）
    - _要件: 2.1, 2.4, 2.6, 2.7_

  - [x] 7.2 大会作成APIを実装
    - API Route: /api/tournaments/route.ts (POST)
    - バリデーション（期間、楽曲数、アクティブ大会制限）
    - トランザクション処理（大会 + 楽曲の関連付け）
    - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

  - [x] 7.3 大会作成のプロパティテストを作成
    - **プロパティ 4: 大会作成の完全性**
    - **プロパティ 5: アクティブ大会の制限**
    - **プロパティ 6: 大会の楽曲要件**
    - **プロパティ 7: 大会更新の時間的制約**
    - **検証: 要件 2.1, 2.2, 2.3, 2.4, 2.5**

- [x] 8. 大会一覧・詳細表示の実装
  - [x] 8.1 大会一覧コンポーネントを作成
    - TournamentList コンポーネント
    - TournamentCard コンポーネント
    - フィルタリングUI（ゲームタイプ、ステータス）
    - 大会一覧ページ（/tournaments/page.tsx）
    - _要件: 7.1, 7.3, 7.4, 7.5_

  - [x] 8.2 大会詳細ページを作成
    - 大会情報表示
    - 参加者リスト
    - 対象楽曲リスト
    - 参加/離脱ボタン
    - 大会詳細ページ（/tournaments/[id]/page.tsx）
    - _要件: 7.2, 7.6_

  - [x] 8.3 大会取得APIを実装
    - API Route: /api/tournaments/route.ts (GET)
    - API Route: /api/tournaments/[id]/route.ts (GET)
    - フィルタリングロジック
    - _要件: 7.1, 7.2, 7.3, 7.4_

  - [x] 8.4 大会表示のプロパティテストを作成
    - **プロパティ 21: 公開大会の一覧表示**
    - **プロパティ 22: 大会詳細の完全性**
    - **プロパティ 23: ゲームタイプによるフィルタリング**
    - **プロパティ 24: 大会ステータスの計算**
    - **検証: 要件 7.1, 7.2, 7.3, 7.4, 7.5, 7.6**

- [x] 9. チェックポイント - 大会作成と表示の動作確認
  - すべてのテストが通過することを確認
  - 大会の作成、一覧表示、詳細表示が機能することを確認
  - 質問があればユーザーに確認

- [x] 10. 大会参加機能の実装
  - [x] 10.1 参加/離脱APIを実装
    - API Route: /api/tournaments/[id]/join/route.ts
    - API Route: /api/tournaments/[id]/leave/route.ts
    - 重複参加チェック
    - 通知作成
    - _要件: 3.1, 3.2, 3.4, 3.5, 3.6, 9.1, 9.4_

  - [x] 10.2 参加機能のプロパティテストを作成
    - **プロパティ 8: 参加記録の作成と削除**
    - **プロパティ 9: 無制限の参加**
    - **プロパティ 10: 重複参加の防止**
    - **検証: 要件 3.1, 3.2, 3.3, 3.6**

- [x] 11. スコア提出機能（手動）の実装
  - [x] 11.1 スコア提出フォームコンポーネントを作成
    - ScoreSubmitForm コンポーネント
    - 楽曲選択
    - スコア入力
    - スコア提出ページ（/submit/[tournamentId]/page.tsx）
    - _要件: 4.3, 4.4, 4.6_

  - [x] 11.2 スコア提出APIを実装
    - API Route: /api/scores/route.ts
    - バリデーション（参加者チェック、スコア範囲）
    - ランキング再計算トリガー
    - _要件: 4.3, 4.4, 4.6, 6.1_

  - [x] 11.3 スコア提出のプロパティテストを作成
    - **プロパティ 11: スコア提出の検証と保存**
    - **プロパティ 12: スコア提出の関連付け**
    - **プロパティ 13: スコア提出による記録更新**
    - **プロパティ 17: ランキングの自動再計算**
    - **検証: 要件 4.3, 4.4, 4.6, 6.1**

- [x] 12. 画像提出機能の実装
  - [x] 12.1 画像アップロードコンポーネントを作成
    - ImageUpload コンポーネント
    - ドラッグ&ドロップ対応
    - プレビュー表示
    - _要件: 5.1, 5.6_

  - [x] 12.2 画像アップロードAPIを実装
    - Supabase Storage への画像アップロード
    - 保留中のスコアレコード作成
    - _要件: 5.1, 5.2, 5.5_

  - [x] 12.3 画像提出レビュー機能を実装
    - 開催者管理画面に画像提出リスト表示
    - スコア承認・入力フォーム
    - _要件: 5.3, 8.2_

  - [x] 12.4 画像提出のプロパティテストを作成
    - **プロパティ 14: 画像の保存と保留状態**
    - **プロパティ 15: 開催者によるスコア承認**
    - **検証: 要件 5.1, 5.2, 5.3, 5.5**

- [x] 13. ランキング表示機能の実装
  - [x] 13.1 ランキングテーブルコンポーネントを作成
    - RankingTable コンポーネント
    - ソート機能
    - ランキングページ（/tournaments/[id]/ranking/page.tsx）
    - _要件: 6.2, 6.6_

  - [x] 13.2 ランキング取得APIを実装
    - calculate_ranking 関数を呼び出し
    - 公開/非公開の権限チェック
    - _要件: 6.1, 6.4, 6.5_

  - [x] 13.3 ランキングのプロパティテストを作成
    - **プロパティ 18: ランキングの表示形式**
    - **プロパティ 19: 公開大会のランキング閲覧**
    - **プロパティ 20: 非公開大会のランキング制限**
    - **検証: 要件 6.2, 6.4, 6.5, 6.6**

- [x] 14. チェックポイント - スコア提出とランキングの動作確認
  - すべてのテストが通過することを確認
  - スコア提出（手動・画像）とランキング表示が機能することを確認
  - 質問があればユーザーに確認

- [x] 15. 開催者管理画面の実装
  - [x] 15.1 開催者管理ページを作成
    - 提出一覧表示
    - 参加者統計表示
    - ランキング再計算ボタン
    - 大会編集リンク
    - 開催者管理ページ（/my/tournaments/[id]/manage/page.tsx）
    - _要件: 8.1, 8.3, 8.4, 8.5, 8.6_

  - [x] 15.2 ランキング再計算APIを実装
    - API Route: /api/tournaments/[id]/recalculate/route.ts
    - 開催者権限チェック
    - _要件: 6.3, 8.3_

  - [x] 15.3 開催者機能のプロパティテストを作成
    - **プロパティ 25: 開催者による提出の閲覧**
    - **プロパティ 26: 参加者統計の計算**
    - **検証: 要件 8.1, 8.4**

- [x] 16. ブックマークレットの実装
  - [x] 16.1 ブックマークレット用APIを実装
    - API Route: /api/bookmarklet/submit/route.ts
    - CORS設定
    - 認証トークン検証
    - _要件: 4.2, 4.3_

  - [x] 16.2 ブックマークレットスクリプトを作成
    - DOM解析ロジック（各ゲームサイト用）
    - API呼び出し
    - エラーハンドリング
    - 停止フラグチェック
    - _要件: 4.1, 4.2, 4.5_

  - [x] 16.3 ブックマークレットのユニットテストを作成
    - モックDOMでの解析テスト
    - API呼び出しのテスト
    - エラーハンドリングのテスト
    - _要件: 4.1, 4.2_

- [x] 17. 通知機能の実装
  - [x] 17.1 通知コンポーネントを作成
    - NotificationList コンポーネント
    - 未読バッジ
    - 通知ドロップダウン
    - _要件: 9.2_

  - [x] 17.2 通知取得・更新APIを実装
    - API Route: /api/notifications/route.ts (GET)
    - API Route: /api/notifications/[id]/route.ts (PATCH)
    - 既読マーク機能
    - _要件: 9.3, 9.6_

  - [x] 17.3 通知作成ロジックを統合
    - 大会開始時の通知
    - 大会終了時の通知
    - 新規参加者の通知
    - 規約更新の通知
    - _要件: 9.1, 9.4, 12.6_

  - [x] 17.4 通知機能のプロパティテストを作成
    - **プロパティ 27: イベント通知の作成**
    - **プロパティ 28: 未読通知の識別**
    - **プロパティ 29: 通知の既読マーク**
    - **プロパティ 30: 通知履歴の閲覧**
    - **プロパティ 33: 規約更新の通知**
    - **検証: 要件 9.1, 9.2, 9.3, 9.6, 12.6**

- [x] 18. 利用規約ページの実装
  - [x] 18.1 利用規約ページを作成
    - 規約コンテンツ
    - 免責事項
    - 非公式サービスの明記
    - 利用規約ページ（/terms/page.tsx）
    - _要件: 12.1, 12.3, 12.4_

  - [x] 18.2 規約同意チェックを登録フローに追加
    - 登録フォームにチェックボックス追加
    - バリデーション
    - _要件: 12.2_

  - [x] 18.3 フッターに規約リンクを追加
    - すべてのページのフッターに表示
    - _要件: 12.5_

  - [x] 18.4 利用規約のユニットテストを作成
    - 規約ページの表示テスト
    - 規約同意なしの登録拒否テスト
    - フッターリンクの存在テスト
    - _要件: 12.1, 12.2, 12.5_

- [x] 19. 大会終了時の自動処理の実装
  - [x] 19.1 画像削除バッチ処理を作成
    - 終了した大会の画像を検索
    - Supabase Storage から削除
    - _要件: 5.4_

  - [x] 19.2 画像削除のプロパティテストを作成
    - **プロパティ 16: 大会終了時の画像削除**
    - **検証: 要件 5.4**

- [x] 20. チェックポイント - すべての機能の統合テスト
  - すべてのテストが通過することを確認
  - エンドツーエンドのユーザーフローをテスト
  - 質問があればユーザーに確認

- [x] 21. UIの改善とレスポンシブ対応
  - [x] 21.1 共通UIコンポーネントを作成
    - Button コンポーネント
    - Input コンポーネント
    - Card コンポーネント
    - Modal コンポーネント
    - Toast 通知

  - [x] 21.2 レスポンシブデザインを実装
    - モバイル対応
    - タブレット対応
    - デスクトップ最適化

  - [x] 21.3 ローディング状態とエラー表示を改善
    - Suspense境界
    - エラー境界
    - スケルトンローディング

- [x] 22. パフォーマンス最適化
  - [x] 22.1 画像最適化
    - Next.js Image コンポーネントの使用
    - 遅延読み込み

  - [x] 22.2 データフェッチング最適化
    - React Query の導入（オプション）
    - キャッシング戦略
    - ページネーション

  - [x] 22.3 バンドルサイズ最適化
    - 動的インポート
    - Tree shaking の確認

- [x] 23. セキュリティ強化
  - [x] 23.1 入力サニタイゼーション
    - XSS対策
    - SQLインジェクション対策（RLSで保護済み）

  - [x] 23.2 レート制限の実装
    - API エンドポイントのレート制限
    - ブックマークレットのレート制限

  - [x] 23.3 CSRF対策
    - Next.js の組み込み保護を確認

- [x] 24. デプロイ準備
  - [x] 24.1 環境変数の設定
    - Vercel での環境変数設定
    - 本番用 Supabase 接続情報

  - [x] 24.2 public スキーマへのマイグレーション
    - dev スキーマから public スキーマへのスキーマコピー
    - データマイグレーション（必要に応じて）
    - _要件: 11.2, 11.3, 11.5_

  - [x] 24.3 CI/CD パイプラインの設定
    - GitHub Actions でのテスト自動実行
    - main ブランチへの自動デプロイ
    - feature ブランチのプレビューデプロイ
    - _要件: 14.1, 14.2_

- [ ] 25. 最終チェックポイント - 本番デプロイ前の確認
  - すべてのテストが通過することを確認
  - 本番環境での動作確認
  - セキュリティチェック
  - パフォーマンステスト
  - 質問があればユーザーに確認

## 注意事項

- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントは段階的な検証を保証します
- プロパティテストは普遍的な正確性プロパティを検証します
- ユニットテストは特定の例とエッジケースを検証します
